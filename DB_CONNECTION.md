# Настройка подключения к базе данных

Этот документ объясняет, как настроить и сконфигурировать безопасное подключение к базе данных для ProcessCraft.

## Обзор

ProcessCraft использует Microsoft SQL Server 2008 в качестве сервера базы данных. Подключение управляется через пул подключений для оптимизации производительности и использования ресурсов. Все учетные данные хранятся в зашифрованном виде с использованием хеширования PBKDF2.

## Конфигурация

### Переменные окружения (только для этапа настройки)

Во время обычного запуска приложения переменные окружения не используются для подключения к БД. Файл `.env` требуется только однократно для скрипта настройки, который преобразует все значения в хеши и шифротексты и сохраняет их в `src/db/auth-db.json` и `src/db/salt/`.

Создайте файл `.env` в корневой директории проекта на основе следующего примера:

```
# Database Configuration
DB_SERVER=OZO-62,1433
DB_DATABASE=ProcessCraftBD

# Regular user credentials
DB_USER_REGULAR=AppSuperUser
DB_PASSWORD_REGULAR=uU7@!Kx2_superUserStrongPwd

# Super admin credentials
DB_USER_ADMIN=AppSuperAdmin
DB_PASSWORD_ADMIN=aA3$!Qp9_superAdminStrongPwd

# Path for storing salt files
DB_PATH_SALT=src/db/salt

; ключ шифрования генерируется автоматически скриптом настройки, это значение не требуется
```

### Настройки пула подключений

Пул подключений сконфигурирован со следующими параметрами:
- Максимум подключений: 10
- Минимум подключений: 0
- Таймаут простоя: 30000 миллисекунд (30 секунд)
- Шифрование: Отключено (требуется для совместимости с SQL Server 2008)

## Безопасность учетных данных

### Хеширование паролей

ProcessCraft использует PBKDF2 с 10,000 итераций для хеширования всех учетных данных базы данных. Это обеспечивает:
- Защиту от компрометации базы данных (даже если файлы будут украдены, пароли останутся в безопасности)
- Защиту от атак радужной таблицы (каждый пароль использует уникальную соль)
- Совместимость с существующей инфраструктурой SQL Server

### Файлы солей

Каждый параметр подключения (сервер, база данных, имя пользователя, пароль) хешируется с использованием уникального файла соли, хранящегося в директории `src/db/salt/`. Эти файлы создаются автоматически при запуске скрипта настройки.

### Шифрование параметров подключения

Скрипт настройки генерирует 32-байтовый ключ шифрования в `src/db/salt/enc_key.json` и записывает ссылку на него в `auth-db.json`. Фактические значения `server`, `database`, а также пары `username/password` для поддерживаемых аккаунтов шифруются (AES-256-GCM) и сохраняются в разделе `encrypted_config` файла `auth-db.json`.

## Детали реализации

### Файл подключения

Подключение к базе данных реализовано в [src/db/connection.js](file:///c%3A/Users/KodochigovV/Documents/Projects/ProcessCraft/src/db/connection.js):

1. Загружает `auth-db.json` и ключ из `src/db/salt/enc_key.json`
2. Дешифрует `server`, `database` и `username/password` выбранного типа пользователя
3. Проверяет учетные данные через хеши в `auth-db.json`
4. Настраивает пул подключений с указанными параметрами
5. Проверяет подключение с помощью тестового запроса
6. Экспортирует фабрики и библиотеку `mssql` для использования в модулях

### Настройка доступа

Перед первым запуском приложения необходимо выполнить скрипт настройки:

```bash
node src/db/setup-db-access.js
```

Этот скрипт:
1. Читает исходные параметры из `.env` (разово)
2. Генерирует ключ шифрования в `src/db/salt/enc_key.json`
3. Хеширует все параметры подключения (PBKDF2) и записывает ссылки на файлы солей
4. Шифрует `server`, `database`, `username/password` и сохраняет их в `encrypted_config`
5. Сохраняет всё в [src/db/auth-db.json](file:///c%3A/Users/KodochigovV/Documents/Projects/ProcessCraft/src/db/auth-db.json)

### Использование в модулях приложения

Чтобы использовать безопасное подключение к базе данных в ваших модулях:

```javascript
const { initializeConnection } = require('../db/connection');

// Подключение от имени суперадмина
initializeConnection('superadmin').then(pool => {
  return pool.request()
    .query('SELECT * FROM users WHERE id = @id')
    .then(result => {
      // Обработка результата
      console.log(result.recordset);
    })
    .catch(err => {
      console.error('Ошибка запроса:', err);
    })
    .finally(() => {
      pool.close();
    });
});

// Подключение от имени обычного пользователя
initializeConnection('regular').then(pool => {
  // Аналогично выше
});
```

## Тестирование подключения

### Комплексное тестирование

Для выполнения полного тестирования системы безопасности базы данных выполните:

```bash
node src/db/system-test.js
```

Этот скрипт тестирует:
1. Сервис аутентификации
2. Модуль шифрования/дешифрования
3. Подключение к базе данных
4. Хеширование и проверку учетных данных
5. Проверку учетных данных через хеши
6. Подключение к базе данных, используя только зашифрованные данные
7. Хранилище учетных данных
8. Операции с базой данных

### Тестирование хешированного подключения

Для демонстрации безопасного подключения через хеширование:

```bash
node src/db/hashed-connection-example.js
```

## Устранение неполадок

### Частые проблемы

1. **Таймаут подключения**: Проверьте, запущен ли SQL Server и доступен ли он
2. **Ошибка аутентификации**: Убедитесь, что скрипт настройки был выполнен и файл auth-db.json существует
3. **База данных не найдена**: Убедитесь, что база данных существует на сервере
4. **Отсутствуют переменные окружения**: Проверьте наличие файла .env с корректными данными

### Сообщения об ошибках

- "Database connection failed": Проверьте адрес сервера и сетевое подключение
- "Login failed for user": Проверьте учетные данные в файле .env и выполните скрипт настройки
- "Database 'ProcessCraftBD' does not exist": Создайте базу данных на вашем экземпляре SQL Server
- "Файл auth-db.json не найден": Выполните скрипт настройки доступа к СУБД

## Соображения безопасности

1. Никогда не фиксируйте файл `.env` в системе контроля версий
2. Используйте надежные пароли для учетных записей базы данных
3. Ограничьте разрешения базы данных только тем, что необходимо для приложения
4. Регулярно обновляйте файлы солей и хеши при изменении учетных данных
5. В производственной среде рассмотрите возможность включения шифрования, если используется более новая версия SQL Server
6. Все учетные данные хранятся в зашифрованном виде - даже если файлы будут скомпрометированы, оригинальные пароли останутся в безопасности