# Безопасность базы данных ProcessCraft

Этот документ объединяет и обновляет всю информацию о безопасности базы данных в приложении ProcessCraft, включая систему аутентификации, шифрование учетных данных и настройку подключения.

## Обзор

ProcessCraft использует Microsoft SQL Server 2008 в качестве сервера базы данных. Для обеспечения безопасности учетных данных и подключения реализована двухуровневая система:

1. **Система аутентификации** - хранит хеши паролей пользователей
2. **Система шифрования** - шифрует учетные данные для подключения к базе данных

## Учетные записи пользователей базы данных

### Суперадмин приложения
- **Имя пользователя**: AppSuperAdmin
- **Пароль**: aA3$!Qp9_superAdminStrongPwd (хешируется и не хранится в открытом виде)
- **Назначение**: Для административных задач, требующих полного доступа к базе данных
- **Тип учетной записи**: superadmin

### Обычный пользователь приложения
- **Имя пользователя**: AppSuperUser
- **Пароль**: uU7@!Kx2_superUserStrongPwd (хешируется и не хранится в открытом виде)
- **Назначение**: Для стандартных операций приложения с ограниченными правами доступа к базе данных
- **Тип учетной записи**: regular

## Система аутентификации

### Компоненты

#### 1. Сервис аутентификации (`src/db/auth-service.js`)
Основной компонент системы, отвечающий за:
- Хеширование паролей с использованием PBKDF2
- Верификацию паролей
- Управление учетными записями пользователей
- Хранение хешей паролей в отдельной базе данных

#### 2. База данных аутентификации (`src/db/auth-db.json`)
Содержит хеши паролей и соли:
```json
{
  "users": {
    "AppSuperAdmin": { 
      "username": "AppSuperAdmin", 
      "hash": "...", 
      "salt": "...",
      "login_hash": "...",
      "login_salt_file": "...",
      "password_hash": "...",
      "password_salt_file": "..."
    },
    "AppSuperUser": { 
      "username": "AppSuperUser", 
      "hash": "...", 
      "salt": "...",
      "login_hash": "...",
      "login_salt_file": "...",
      "password_hash": "...",
      "password_salt_file": "..."
    }
  }
}
```

#### 3. Хранилище учетных данных (`src/db/credentials-store.js`)
Хранит только имена пользователей и типы учетных записей без паролей:
```json
{
  "superadmin": { 
    "username": { 
      "encryptedData": "...", 
      "iv": "...", 
      "authTag": "..." 
    }, 
    "userType": "superadmin" 
  },
  "regular": { 
    "username": { 
      "encryptedData": "...", 
      "iv": "...", 
      "authTag": "..." 
    }, 
    "userType": "regular" 
  }
}
```

### Безопасность аутентификации

#### Хеширование паролей
Пароли хешируются с использованием алгоритма PBKDF2:
- 10,000 итераций
- Длина хеша: 64 байта
- Алгоритм хеширования: SHA-512
- Уникальная соль для каждого пароля

#### Хранение данных
- Пароли не хранятся в открытом виде
- Хеши паролей хранятся отдельно от имен пользователей
- Доступ к базе данных аутентификации ограничен

## Система шифрования учетных данных

### Компоненты

#### 1. Модуль шифрования (`src/db/encryption.js`)
Обеспечивает шифрование и дешифрование учетных данных базы данных с использованием AES-256-GCM. Ключ шифрования загружается из файла `src/db/salt/enc_key.json`, ссылка на который хранится в `src/db/auth-db.json`.

#### 2. Зашифрованная конфигурация подключения
Шифротексты параметров `server`, `database`, а также пар `username/password` для поддерживаемых аккаунтов хранятся в разделе `encrypted_config` файла `src/db/auth-db.json`:
```json
{
  "encrypted_config": {
    "server": {
      "encryptedData": "...",
      "iv": "...",
      "authTag": "..."
    },
    "database": {
      "encryptedData": "...",
      "iv": "...",
      "authTag": "..."
    },
    "users": {
      "AppSuperAdmin": {
        "username": {
          "encryptedData": "...",
          "iv": "...",
          "authTag": "..."
        },
        "password": {
          "encryptedData": "...",
          "iv": "...",
          "authTag": "..."
        }
      },
      "AppSuperUser": {
        "username": {
          "encryptedData": "...",
          "iv": "...",
          "authTag": "..."
        },
        "password": {
          "encryptedData": "...",
          "iv": "...",
          "authTag": "..."
        }
      }
    }
  }
}
```

### Особенности шифрования
- **Алгоритм**: AES-256-GCM (аутентифицированное шифрование)
- **Обнаружение подделки**: через теги аутентификации
- **Ключ**: 32 байта, хранится в `src/db/salt/enc_key.json` (защищать ACL)
- **Получение ключа**: без KDF на рантайме, напрямую из файла ключа

## Настройка подключения к базе данных

### Конфигурация
Во время обычного запуска приложения переменные окружения для подключения не используются. `.env` требуется только на этапе настройки, чтобы хешировать и зашифровать исходные значения. После настройки приложение читает только `auth-db.json` и ключ из `src/db/salt/enc_key.json`.

### Обязательные переменные окружения
Следующие переменные должны быть определены в файле `.env`:
- `DB_SERVER` - Адрес сервера базы данных (например, `localhost,1433`)
- `DB_DATABASE` - Имя базы данных
- `DB_USER_REGULAR` - Имя обычного пользователя базы данных
- `DB_PASSWORD_REGULAR` - Пароль обычного пользователя базы данных
- `DB_USER_ADMIN` - Имя администратора базы данных
- `DB_PASSWORD_ADMIN` - Пароль администратора базы данных

### Опциональные переменные окружения
- `DB_PATH_SALT` - Путь к директории для хранения файлов солей (по умолчанию: `src/db/salt`)

### Настройки пула подключений
- Максимум подключений: 10
- Минимум подключений: 0
- Таймаут простоя: 30000 миллисекунд (30 секунд)
- Шифрование: Отключено (совместимо с SQL Server 2008), `trustServerCertificate: true`

### Логика подключения
1. `src/db/connection.js` загружает `auth-db.json` и ключ из `src/db/salt/enc_key.json`
2. Дешифрует `server`, `database`, `username/password` для выбранного типа пользователя
3. Валидирует значения против хешей, записанных в `auth-db.json`
4. Создаёт пул `mssql` и выполняет тестовый запрос

## Использование

### Аутентификация пользователя
```javascript
const { verifyUserCredentials } = require('./src/db/auth-service');
const isValid = verifyUserCredentials('AppSuperAdmin', 'superAdminStrongPwd');
```

### Подключение к базе данных
```javascript
const { initializeConnection } = require('./src/db/connection');
// Подключение к базе данных суперадмином (значения берутся из зашифрованного раздела)
const pool = await initializeConnection('superadmin');
```

### Шифрование/дешифрование данных
```javascript
const { encrypt, decrypt } = require('./src/db/encryption');
const ciphertext = encrypt('секрет');
const plaintext = decrypt(ciphertext);
```

## Тестирование

### Запуск тестов
```bash
node src/db/system-test.js
```

Этот скрипт тестирует все компоненты системы безопасности:
1. Проверка существования и валидности auth-db.json
2. Запуск скрипта настройки доступа к СУБД
3. Тестирование сервиса аутентификации
4. Тестирование модуля шифрования/дешифрования
5. Тест подключения к базе данных
6. Тест хеширования и проверки учетных данных
7. Тест проверки учетных данных через хеши
8. Тест подключения к базе данных через хеширование паролей
9. Тестирование хранилища учетных данных
10. Тестирование операций БД

## Безопасность

### Рекомендации по безопасности
1. Не храните пароли в коде и не используйте `.env` на рантайме
2. Храните ключ шифрования вне репозитория, ограничьте доступ к `src/db/salt/`
3. Регулярно ротируйте ключ и перегенерируйте `encrypted_config`
4. Используйте сложные пароли и минимально необходимые права БД
5. Включайте транспортное шифрование, если используете версию SQL Server новее 2008

### Хранение учетных данных
- Рассмотрите перенос `auth-db.json` в защищённое локальное хранилище
- Ограничьте права на чтение каталога `src/db/salt/`
- Обеспечьте резервное копирование с шифрованием