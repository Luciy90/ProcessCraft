<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <title>Прав доступа — Модальное окно</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  </head>
  <body class="antialiased bg-neutral-950 text-white/90 selection:bg-white/10 selection:text-white/90">
    <div class="min-h-screen flex items-center justify-center p-6">
      <button id="openModalBtn" class="h-10 px-4 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 active:bg-white/15 transition-colors">
        Открыть модальное окно
      </button>
    </div>

    <!-- Modal -->
    <div id="settingsModal" class="fixed inset-0 z-50 hidden items-center justify-center p-6" role="dialog" aria-modal="true" aria-labelledby="settings-title">
      <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

      <!-- Content -->
      <div class="modal-content relative mx-auto my-auto w-[min(95vw,1100px)] max-w-[1100px] h-[80vh] overflow-hidden flex flex-col gap-4 rounded-xl border border-white/10 bg-neutral-900 shadow-xl p-6">
        <header class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <h2 id="settings-title" class="text-xl font-semibold tracking-tight">Настройки доступа</h2>
            <div class="hidden md:flex items-center gap-2 text-xs text-white/50">
              <svg data-lucide="dot" class="h-4 w-4"></svg>
              <span>Активная роль:</span>
              <span id="activeRoleName" class="px-1.5 py-0.5 rounded bg-white/5 border border-white/10 text-white/80">—</span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button id="closeModalX" class="h-9 w-9 rounded-lg border border-white/10 hover:bg-white/10 active:bg-white/20 transition-colors grid place-items-center" aria-label="Закрыть">
              <svg data-lucide="x" class="h-4 w-4"></svg>
            </button>
          </div>
        </header>

        <!-- Top helpers -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="flex items-center gap-2">
            <div class="relative flex-1">
              <svg data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-white/50"></svg>
              <input id="rolesSearch" type="text" placeholder="Поиск ролей…" class="w-full h-9 pl-9 pr-3 rounded-lg bg-white/5 border border-white/10 placeholder-white/40 text-sm focus:outline-none focus:ring-2 focus:ring-white/10 focus:border-white/20" />
            </div>
            <div class="hidden md:flex items-center gap-2 text-xs text-white/50">
              <svg data-lucide="users" class="h-4 w-4"></svg>
              <span>Роли</span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <div class="relative flex-1">
              <svg data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-white/50"></svg>
              <input id="modulesSearch" type="text" placeholder="Поиск по модулям и правам…" class="w-full h-9 pl-9 pr-3 rounded-lg bg-white/5 border border-white/10 placeholder-white/40 text-sm focus:outline-none focus:ring-2 focus:ring-white/10 focus:border-white/20" />
            </div>
            <div class="flex items-center gap-2">
              <button id="expandAllBtn" class="h-9 px-3 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 active:bg-white/20 transition-colors flex items-center gap-2">
                <svg data-lucide="chevrons-down-up" class="h-4 w-4"></svg>
                <span class="hidden sm:inline text-sm">Раскрыть всё</span>
              </button>
              <button id="collapseAllBtn" class="h-9 px-3 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 active:bg-white/20 transition-colors flex items-center gap-2">
                <svg data-lucide="chevrons-up-down" class="h-4 w-4"></svg>
                <span class="hidden sm:inline text-sm">Свернуть всё</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Columns -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1 min-h-0">
          <!-- Roles -->
          <section class="flex flex-col min-h-0">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-medium tracking-tight flex items-center gap-2">
                <svg data-lucide="users" class="h-5 w-5"></svg>
                Роли
              </h3>
              <div class="hidden sm:flex items-center gap-2 text-xs text-white/50">
                <svg data-lucide="info" class="h-4 w-4"></svg>
                <span>Выберите роль для редактирования</span>
              </div>
            </div>
            <div id="rolesList" class="flex-1 min-h-0 rounded-lg border border-white/10 bg-white/5 overflow-y-auto divide-y divide-white/10">
              <!-- filled by script -->
            </div>
          </section>

          <!-- Modules -->
          <section class="flex flex-col min-h-0">
            <div class="mb-3 flex flex-col gap-2">
              <div class="grid items-center px-4 rounded-lg border border-white/10 bg-white/5" style="grid-template-columns: minmax(0,1fr) auto; column-gap: 3.35rem;">
                <h3 class="text-lg font-medium tracking-tight flex items-center gap-2 py-2">
                  <svg data-lucide="boxes" class="h-5 w-5"></svg>
                  Разрешения
                </h3>
                <div class="md:flex justify-center text-xs text-white/60 py-2">
                  <div class="flex items-center gap-1">
                    <svg data-lucide="check-square" class="h-4 w-4"></svg>
                    <span class="hidden md:inline">Включено</span>
                  </div>
                </div>
              </div>

              <div class="flex flex-wrap items-center gap-2">
                <button id="presetViewAll" class="h-8 px-3 rounded-md border border-emerald-400/30 bg-emerald-500/10 hover:bg-emerald-500/15 text-emerald-200 text-xs transition-colors flex items-center gap-2">
                  <svg data-lucide="eye" class="h-4 w-4"></svg>
                  <span>Разрешить: всё</span>
                </button>
                <button id="presetDisableAll" class="h-8 px-3 rounded-md border border-rose-400/30 bg-rose-500/10 hover:bg-rose-500/15 text-rose-200 text-xs transition-colors flex items-center gap-2">
                  <svg data-lucide="shield-off" class="h-4 w-4"></svg>
                  <span>Запретить: всё</span>
                </button>
              </div>
            </div>

            <div id="modulesTree" class="flex-1 min-h-0 rounded-lg border border-white/10 bg-white/5 overflow-y-auto p-2 space-y-2">
              <!-- filled by script -->
            </div>
          </section>
        </div>

        <!-- Footer -->
        <footer class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 pt-2 border-t border-white/10">
          <div class="flex flex-wrap items-center gap-3 text-xs text-white/70">
            <div class="flex items-center gap-2">
              <svg data-lucide="info" class="h-4 w-4"></svg>
              <span>Изменения применяются к выбранной роли. Чекбоксы наследуются вниз по дереву.</span>
            </div>
            <div class="hidden md:block h-4 w-px bg-white/10"></div>
            <div class="flex items-center gap-2">
              <span class="text-white/50">Итого:</span>
              <span class="px-2 py-1 rounded-md bg-white/5 border border-white/10 text-white/80">Строк: <b id="countRows" class="font-medium">0</b></span>
              <span class="px-2 py-1 rounded-md bg-white/5 border border-white/10 text-white/80">Подуровни: <b id="levelsBreakdown" class="font-medium">—</b></span>
              <span class="px-2 py-1 rounded-md bg-emerald-500/10 border border-emerald-400/20 text-emerald-200">Активные: <b id="countActive" class="font-medium">0</b></span>
              <span class="px-2 py-1 rounded-md bg-rose-500/10 border border-rose-400/20 text-rose-200">Запреты: <b id="countDenied" class="font-medium">0</b></span>
            </div>
          </div>
          <div class="flex justify-end gap-3">
            <button id="cancel" class="h-9 px-4 rounded-lg border border-white/10 hover:bg-white/10 active:bg-white/20 transition-colors">Отмена</button>
            <button id="apply" class="h-9 px-4 rounded-lg border border-emerald-400/40 bg-emerald-500/10 hover:bg-emerald-500/20 active:bg-emerald-500/25 text-emerald-200 transition-colors">Применить</button>
          </div>
        </footer>
      </div>
    </div>

    <script>
      // Init icons
      document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons({ attrs: { "stroke-width": 1.5 } });
      });

      // Data
      const roles = [
        { id: "admin", name: "Администратор", info: "Полный доступ", color: "emerald" },
        { id: "editor", name: "Редактор", info: "Управление контентом", color: "sky" },
        { id: "viewer", name: "Наблюдатель", info: "Только чтение", color: "violet" },
        { id: "contractor", name: "Подрядчик", info: "Ограниченный доступ", color: "amber" }
      ];

      const modules = [
        { id: "dashboard", name: "Панель", children: [] },
        {
          id: "projects", name: "Проекты", children: [
            { id: "projects.view", name: "Просмотр", children: [] },
            { id: "projects.edit", name: "Редактирование", children: [] },
            { id: "projects.delete", name: "Удаление", children: [] }
          ]
        },
        {
          id: "reports", name: "Отчеты", children: [
            { id: "reports.sales", name: "Продажи", children: [] },
            { id: "reports.finance", name: "Финансы", children: [] }
          ]
        },
        {
          id: "settings", name: "Настройки", children: [
            { id: "settings.users", name: "Пользователи", children: [] },
            { id: "settings.roles", name: "Роли", children: [] },
            { id: "settings.billing", name: "Оплата", children: [] }
          ]
        }
      ];

      // Flatten helpers
      function flattenWithDepth(tree) {
        const out = [];
        const walk = (nodes, depth) => {
          nodes.forEach(n => {
            out.push({ id: n.id, depth, children: n.children || [] });
            if (n.children?.length) walk(n.children, depth + 1);
          });
        };
        walk(tree, 0);
        return out;
      }
      const flatModules = flattenWithDepth(modules);
      const allModuleIds = flatModules.map(n => n.id);

      // Precompute per-level stats (structure is static)
      const levelCounts = (() => {
        const map = new Map();
        flatModules.forEach(n => map.set(n.depth, (map.get(n.depth) || 0) + 1));
        return map;
      })();
      const totalRows = flatModules.length;

      // Permissions per role (single "checked" set)
      const rolePermissions = {
        admin: { checked: new Set(allModuleIds) },
        editor: { checked: new Set(["dashboard", "projects", "projects.view", "projects.edit", "reports"]) },
        viewer: { checked: new Set(["dashboard", "projects", "projects.view", "reports", "reports.sales"]) },
        contractor: { checked: new Set(["projects", "projects.view"]) }
      };

      // UI elements
      const modal = document.getElementById("settingsModal");
      const openModalBtn = document.getElementById("openModalBtn");
      const closeModalX = document.getElementById("closeModalX");
      const cancelBtn = document.getElementById("cancel");
      const applyBtn = document.getElementById("apply");
      const rolesList = document.getElementById("rolesList");
      const modulesTree = document.getElementById("modulesTree");

      const rolesSearch = document.getElementById("rolesSearch");
      const modulesSearch = document.getElementById("modulesSearch");
      const expandAllBtn = document.getElementById("expandAllBtn");
      const collapseAllBtn = document.getElementById("collapseAllBtn");

      const presetViewAll = document.getElementById("presetViewAll");
      const presetDisableAll = document.getElementById("presetDisableAll");

      // New counter refs
      const countRowsEl = document.getElementById("countRows");
      const levelsBreakdownEl = document.getElementById("levelsBreakdown");
      const countActiveEl = document.getElementById("countActive");
      const countDeniedEl = document.getElementById("countDenied");

      const activeRoleNameEl = document.getElementById("activeRoleName");

      // Local state
      let activeRoleId = roles[0].id;
      const stateByRole = new Map(roles.map(r => {
        const s = rolePermissions[r.id] || { checked: new Set() };
        return [r.id, { checked: new Set(s.checked) }];
      }));

      // Filters and view state
      let rolesQuery = "";
      let modulesQuery = "";

      // Track expanded nodes (preserves open state across re-renders)
      const expandedIds = new Set();

      function setForAll(tree, set, on) {
        const toggle = (nodes) => {
          nodes.forEach((n) => {
            if (on) set.add(n.id); else set.delete(n.id);
            if (n.children?.length) toggle(n.children);
          });
        };
        toggle(tree);
      }

      function filterTree(nodes, query) {
        const q = (query || "").trim().toLowerCase();
        if (!q) {
          return JSON.parse(JSON.stringify(nodes));
        }
        const walk = (arr) => {
          const out = [];
          for (const n of arr) {
            const nameMatch = n.name.toLowerCase().includes(q);
            const children = n.children?.length ? walk(n.children) : [];
            if (nameMatch || children.length) {
              out.push({ id: n.id, name: n.name, children });
            }
          }
          return out;
        };
        return walk(nodes);
      }

      // Render roles
      function renderRoles() {
        rolesList.innerHTML = "";
        const q = rolesQuery.trim().toLowerCase();
        roles
          .filter(r => !q || r.name.toLowerCase().includes(q) || (r.info && r.info.toLowerCase().includes(q)))
          .forEach((r) => {
            const row = document.createElement("button");
            row.type = "button";
            row.className = "w-full flex items-center gap-3 px-4 py-3 hover:bg-white/5 transition-colors text-left";
            row.setAttribute("data-role-id", r.id);

            const isActive = r.id === activeRoleId;

            row.innerHTML = `
              <div class="h-8 w-8 rounded-md border border-white/10 bg-white/5 grid place-items-center">
                <span class="text-xs font-semibold">${r.name.charAt(0)}</span>
              </div>
              <div class="min-w-0 flex-1">
                <div class="flex items-center gap-2">
                  <span class="text-sm font-medium ${isActive ? 'text-white' : 'text-white/90'}">${r.name}</span>
                  ${isActive ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-emerald-500/10 border border-emerald-400/30 text-emerald-200">Выбрано</span>' : ''}
                </div>
                <div class="text-xs text-white/60 truncate">${r.info || ''}</div>
              </div>
            `;

            row.addEventListener("click", () => {
              activeRoleId = r.id;
              expandedIds.clear();
              renderRoles();
              renderModules();
            });

            rolesList.appendChild(row);
          });

        lucide.createIcons({ attrs: { "stroke-width": 1.5 } });
        const activeRole = roles.find(r => r.id === activeRoleId);
        if (activeRoleNameEl && activeRole) activeRoleNameEl.textContent = activeRole.name;
      }

      // Render modules tree
      function renderModules() {
        const roleState = stateByRole.get(activeRoleId);
        const filtered = filterTree(modules, modulesQuery);
        modulesTree.innerHTML = "";

        const build = (nodes, depth = 0, parentEl) => {
          nodes.forEach((node) => {
            const row = document.createElement("div");
            row.className = "grid items-center p-3 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition-colors shadow-sm";
            row.style.gridTemplateColumns = "minmax(0,1fr) auto";
            row.style.columnGap = "3.35rem";
            row.setAttribute("data-node-id", node.id);

            const hasChildren = node.children && node.children.length > 0;
            const paddingLeft = 8 + depth * 16;

            const isChecked = roleState.checked.has(node.id);

            let collapsed = hasChildren ? !expandedIds.has(node.id) : false;

            row.innerHTML = `
              <div class="flex items-center gap-2 min-w-0">
                <button type="button" class="shrink-0 h-6 w-6 rounded-md border border-white/10 bg-white/5 hover:bg-white/10 grid place-items-center" data-expand aria-expanded="${hasChildren ? String(!collapsed) : 'false'}">
                  <svg data-lucide="${hasChildren ? 'chevron-right' : '<svg viewBox="0 0 16 16" class="h-4 w-4 text-slate-500/80" aria-hidden="true"><circle cx="8" cy="8" r="1.25" class="fill-current"></circle></svg>'}" class="h-4 w-4 transition-transform"></svg>
                </button>
                <div class="min-w-0" style="padding-left:${paddingLeft}px">
                  <div class="text-sm leading-6 truncate">${node.name}</div>
                </div>
              </div>

              <div class="flex justify-center">
                <label class="group inline-flex items-center justify-center select-none active:scale-95 transition-transform" style="cursor: pointer;">
                  <input type="checkbox" data-permission="${node.id}" ${isChecked ? "checked" : ""} class="peer sr-only" />
                  <span class="relative h-5 w-5 rounded-md border border-white/10 bg-white/[0.06] shadow-sm transition duration-200 ease-out group-hover:bg-white/10 peer-checked:border-emerald-400/40 peer-checked:bg-emerald-500/20">
                    <span class="absolute inset-0 rounded-md ring-1 ring-inset ring-white/10 transition group-hover:ring-white/20 peer-focus-visible:ring-2 peer-focus-visible:ring-white/25 peer-checked:ring-emerald-400/25"></span>
                    <svg data-lucide="check" class="absolute inset-0 m-auto h-3.5 w-3.5 text-emerald-300 opacity-0 scale-90 transition duration-200 ease-out peer-checked:opacity-100 peer-checked:scale-100"></svg>
                  </span>
                </label>
              </div>
            `;

            // Children container (accordion)
            const childrenWrap = document.createElement("div");
            childrenWrap.setAttribute("data-children", "1");
            childrenWrap.setAttribute("data-node-id", node.id);
            childrenWrap.className = hasChildren ? (collapsed ? "hidden" : "") : "";

            // Expand/collapse
            const expandBtn = row.querySelector("[data-expand]");
            const iconExpand = expandBtn.querySelector("svg");
            if (hasChildren && !collapsed) iconExpand.style.transform = "rotate(90deg)";

            const checkbox = row.querySelector('input[type="checkbox"][data-permission]');

            expandBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              if (!hasChildren) return;

              collapsed = !collapsed;
              childrenWrap.classList.toggle("hidden", collapsed);

              // Rotate icon + reflect state
              iconExpand.style.transform = collapsed ? "rotate(0deg)" : "rotate(90deg)";
              expandBtn.setAttribute("aria-expanded", String(!collapsed));
              if (collapsed) expandedIds.delete(node.id); else expandedIds.add(node.id);

              // Accordion behavior: collapse siblings when opening
              if (!collapsed) {
                const siblings = Array.from(parentEl.querySelectorAll(':scope > div[data-children="1"]'));
                siblings.forEach((wrap) => {
                  if (wrap !== childrenWrap) {
                    wrap.classList.add("hidden");
                    const sibRow = wrap.previousElementSibling;
                    if (sibRow) {
                      const sibIcon = sibRow.querySelector('[data-expand] svg');
                      const sibBtn = sibRow.querySelector('[data-expand]');
                      if (sibIcon) sibIcon.style.transform = "rotate(0deg)";
                      if (sibBtn) sibBtn.setAttribute("aria-expanded", "false");
                      const sibId = sibRow.getAttribute('data-node-id');
                      if (sibId) expandedIds.delete(sibId);
                    }
                  }
                });
              }
            });

            // Checkbox behavior (cascade down)
            checkbox.addEventListener("change", (e) => {
              const on = e.target.checked;
              cascadeChecked(node, stateByRole.get(activeRoleId).checked, on);
              renderModules();
            });

            parentEl.appendChild(row);
            parentEl.appendChild(childrenWrap);

            if (hasChildren) {
              build(node.children, depth + 1, childrenWrap);
            }
          });

          lucide.createIcons({ attrs: { "stroke-width": 1.5 } });
        };

        build(filtered, 0, modulesTree);
        updateCounters();
      }

      function cascadeChecked(node, set, on) {
        const toggle = (n) => {
          if (on) set.add(n.id); else set.delete(n.id);
          if (n.children?.length) n.children.forEach(toggle);
        };
        toggle(node);
      }

      // Counters (Итого)
      function updateCounters() {
        const s = stateByRole.get(activeRoleId);
        const active = s.checked.size;
        const denied = Math.max(0, totalRows - active);

        // rows total
        countRowsEl.textContent = String(totalRows);

        // levels breakdown like: 0: X • 1: Y • 2: Z
        const parts = [];
        const maxLevel = Math.max(...Array.from(levelCounts.keys()));
        for (let d = 0; d <= maxLevel; d++) {
          parts.push(`${d}: ${levelCounts.get(d) || 0}`);
        }
        levelsBreakdownEl.textContent = parts.join(' • ');

        // active / denied
        countActiveEl.textContent = String(active);
        countDeniedEl.textContent = String(denied);
      }

      // Modal controls
      function openModal() {
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }
      function closeModal() {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }

      openModalBtn.addEventListener("click", openModal);
      closeModalX.addEventListener("click", closeModal);
      cancelBtn.addEventListener("click", closeModal);
      applyBtn.addEventListener("click", closeModal);

      // Filters
      rolesSearch.addEventListener("input", (e) => {
        rolesQuery = e.target.value || "";
        renderRoles();
      });
      modulesSearch.addEventListener("input", (e) => {
        modulesQuery = e.target.value || "";
        renderModules();
      });

      // Expand/Collapse all: update expandedIds
      function addAllExpandable(nodes) {
        nodes.forEach(n => {
          if (n.children?.length) {
            expandedIds.add(n.id);
            addAllExpandable(n.children);
          }
        });
      }

      expandAllBtn.addEventListener("click", () => {
        expandedIds.clear();
        addAllExpandable(modules);
        renderModules();
      });

      collapseAllBtn.addEventListener("click", () => {
        expandedIds.clear();
        renderModules();
      });

      // Init
      renderRoles();
      renderModules();

      // Close by clicking overlay
      modal.addEventListener("click", (e) => {
        if (e.target === modal || e.target === modal.firstElementChild) {
          closeModal();
        }
      });

      // Presets
      presetViewAll.addEventListener("click", () => {
        const s = stateByRole.get(activeRoleId);
        setForAll(modules, s.checked, true);
        renderModules();
      });
      presetDisableAll.addEventListener("click", () => {
        const s = stateByRole.get(activeRoleId);
        setForAll(modules, s.checked, false);
        renderModules();
      });
    </script>
  </body>
</html>