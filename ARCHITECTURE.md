# Обзор архитектуры ProcessCraft

## Обзор
ProcessCraft - это настольное приложение, созданное с помощью Electron, которое реализует модульную архитектуру для управления производственными процессами. Приложение использует динамическую загрузку модулей для обеспечения гибкости и расширяемости.

## Основные компоненты

### 1. Основной процесс (Electron)
- **Файл**: `src/main.js`
- **Обязанности**:
  - Управление жизненным циклом Electron
  - Интеграция с нативной ОС
  - Операции с файловой системой
  - Обработка межпроцессного взаимодействия (IPC)
  - Управление пользовательскими данными

### 2. Процесс рендеринга
- **Точка входа**: `src/renderer/index.html`
- **Основное приложение**: `src/renderer/js/app.js`
- **Загрузчик модулей**: `src/renderer/js/module-loader.js`
- **Обязанности**:
  - Рендеринг пользовательского интерфейса
  - Управление модулями
  - Обработка событий
  - Обновления UI

### 3. Модули
Каждая функциональная область приложения реализована как отдельный модуль:
- Панель управления (`dashboard.js`)
- Заказы (`orders.js`)
- Конструкторский отдел (`design.js`)
- Технологи (`technology.js`)
- Склад (`warehouse.js`)
- Производство форм (`molds.js`)
- Обслуживание и ремонт (`maintenance.js`)
- Производственный цех (`production.js`)
- Аналитика (`analytics.js`)
- Профиль (`profile.js`)

### 4. Утилиты
Общая функциональность для всех модулей:
- База данных (`database.js`)
- Уведомления (`notifications.js`)
- Хранилище пользователей (`userStore.js`)
- Утилиты аватаров (`avatarUtils.js`)
- Помощники UI (`ui.js`)

### 5. Конфигурация
- Конфигурация UI (`ui_config.js`)
- Метаданные модулей (файлы `.meta.json`)

## Динамическая загрузка модулей

### Реализация
Приложение использует систему динамической загрузки модулей, которая:
1. Автоматически сканирует директорию `src/renderer/js/modules/`
2. Проверяет и безопасно загружает модули
3. Обеспечивает возможности горячей перезагрузки в режиме разработки
4. Возвращается к статической загрузке для совместимости с браузерами

### Ключевые файлы
- `src/renderer/js/module-loader.js` - Основная реализация загрузчика
- `scripts/build-module-index.js` - Скрипт генерации индекса
- `src/renderer/js/modules/index.json` - Индекс модулей (автогенерируемый)

### Функции API
```javascript
// Загрузка модулей
await loadModules({
    path: 'js/modules',
    dev: true,
    lazyLoad: false
})

// Доступ к модулям
window.getModule(id)
window.getModuleInstance(id)
window.listModules()
window.isModuleAvailable(id)
```

## Система загрузки файлов

### Реализация
Модуль профиля включает в себя комплексную систему загрузки файлов для аватаров и фоновых изображений:
- Управление аватарами с обновлением UI в реальном времени
- Настройка фоновых изображений
- Кэш-бастинг для немедленного отображения
- Обработка ошибок и валидация

### Ключевые особенности
- Валидация типов файлов (только JPEG/PNG)
- Автоматическое создание директорий
- Генерация уникальных имен файлов
- Очистка старых файлов
- Обновление UI в реальном времени с обработкой отказов

## Хранение данных

### База данных на основе JSON
Приложение использует JSON-файлы для хранения данных:
- Расположение: `%APPDATA%\.processcraft\database\`
- Файлы: `orders.json`, `customers.json`, `materials.json` и т.д.
- Утилиты: `src/renderer/js/utils/database.js`

### Пользовательские данные
Данные конкретного пользователя хранятся в:
- Расположение: `Server/users/{username}/`
- Структура:
  ```
  Server/users/{username}/
  ├── assets/
  │   ├── avatar.jpg (или avatar.png)
  │   └── cover.jpg (или cover.png)
  └── user.json
  ```

## Система сборки

### Скрипты NPM
- `npm start` - Запуск приложения с пересборкой модулей
- `npm run dev` - Режим разработки с пересборкой модулей
- `npm run build` - Сборка для продакшена с пересборкой модулей
- `npm run build:modules` - Пересборка индекса модулей
- `npm run build:css` - Сборка CSS в режиме разработки
- `npm run build:css:prod` - Сборка CSS для продакшена
- `npm run dist` - Создание дистрибутива

### Ключевые зависимости
- Electron 22.3.27
- Tailwind CSS 3.4.0
- Electron Store 8.1.0

## Функции безопасности

### Безопасность загрузки модулей
- Валидация moduleId (регулярное выражение: `^[a-z0-9-_]+$`)
- Предотвращение обхода путей
- Загрузка только из доверенных директорий
- Изоляция ошибок между модулями

### Безопасность загрузки файлов
- Валидация типов файлов (проверка MIME-типов)
- Предотвращение обхода путей
- Изоляция пользователей (отдельные папки для каждого пользователя)
- Белый список расширений

## Функции разработки

### Горячая перезагрузка
- Автоматическая перезагрузка модулей в режиме разработки
- Наблюдение за файлами с помощью `chokidar` или `fs.watch`
- Очистка экземпляров с помощью метода `destroy()`
- Активация режима разработки с `dev: true`

### Отладка
- Подробное логирование в режиме разработки
- Инспекция реестра модулей
- Мониторинг производительности
- Изоляция ошибок

## Компоненты UI

### Навигация
- Динамическая генерация навигации из конфигурации
- Элементы навигации на основе модулей
- Подсветка активного модуля
- Адаптивный дизайн

### Модальные окна
- Централизованная система модальных окон
- Обработка форм
- Диалоги взаимодействия с пользователем

### Уведомления
- Система push-уведомлений
- Панель уведомлений
- Уведомления на основе событий
- История отслеживания

## Тестирование и контроль качества

### Ручное тестирование
- Загрузка и переключение модулей
- Функциональность загрузки файлов
- Обновления UI и изменения в реальном времени
- Сценарии обработки ошибок

### Автоматическое тестирование
- Модульные тесты для утилит
- Интеграционные тесты для модулей
- Сквозные тесты для критических путей

## Будущие улучшения

### Планируемые функции
- Горячая перезагрузка модулей в продакшене
- Явные зависимости модулей
- Оптимизация ленивой загрузки
- Песочница модулей
- Стандартизированное API модулей
- Фреймворк тестирования модулей

### Точки расширения
- Пользовательские типы модулей
- Система плагинов
- Маркетплейс модулей
- Аналитика модулей

## Развертывание

### Дистрибутив
- Исполняемый файл Windows (установщик NSIS)
- Настраиваемая директория установки
- Ярлыки на рабочем столе и в меню "Пуск"
- Установка в один клик или пользовательская установка

### Портативность
- Самодостаточное приложение
- Локальное хранение данных
- Нет внешних зависимостей
- Функциональность в офлайн-режиме